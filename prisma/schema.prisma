generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model LoginActivity {
  id         Int       @id @default(autoincrement())
  userId     String    @db.Uuid
  name       String
  loginTime  DateTime  @default(now())
  logoutTime DateTime?
  status     String
  ip         String?
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("login_activity")
}

model User {
  id                  String               @id @default(uuid()) @db.Uuid
  username            String               @unique
  email               String?              @unique
  password            String
  name                String
  role                String
  jabatan             String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  dailyProductionLogs DailyProductionLog[]
  invoices            Invoice[]
  loginActivities     LoginActivity[]
  payments            PaymentHistory[]
  productionRequests  ProductionRequest[]
  purchaseOrders      PurchaseOrder[]
  purchaseOrderPayments PurchaseOrderPayment[]
  shippings           Shipping[]           @relation("DriverToShipping")
  spks                Spk[]
  stockHistories      StockHistory[]
  transactions        Transaction[]

  @@map("user")
}

model Lead {
  id             Int                @id @default(autoincrement())
  nama_owner     String
  nama_pic       String
  nama_toko      String
  jenis_customer String
  alamat_toko    String
  alamat_gmaps   String?
  no_telp        String
  email          String?
  kota           String?
  is_delimited   Boolean            @default(false)
  created_at     DateTime           @default(now())
  updated_at     DateTime           @updatedAt
  invoices       Invoice[]
  payments       PaymentHistory[]
  so_headers     SalesOrderHeader[]
  spks           Spk[]

  @@map("leads")
}

model SalesOrderHeader {
  id             Int              @id @default(autoincrement())
  nomor_so       String           @unique
  lead_id        Int
  status         String           @default("DRAFT")
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  hasSpk         Boolean          @default(false)
  payment_method String           @default("Standard")
  payment_status String           @default("Belum Lunas")
  payments       PaymentHistory[]
  items          SalesOrder[]
  lead           Lead             @relation(fields: [lead_id], references: [id], onDelete: Cascade)
  spks           Spk?

  @@map("sales_order_header")
}

model SalesOrder {
  id                   Int               @id @default(autoincrement())
  kode_barang          String
  nama_barang          String
  jenis_barang         String?
  ukuran_barang        String?
  quantity             Int
  tgl_order            DateTime          @default(now())
  catatan              String?
  created_at           DateTime          @default(now())
  updated_at           DateTime          @updatedAt
  inventory_item_id    String?           @db.Uuid
  is_custom            Boolean           @default(false)
  satuan               String
  harga_satuan         Float?
  harga_total          Float?
  header_id            Int?
  ketebalan_barang     String?
  pcs_per_pack         Int?
  spesifikasi_tambahan String?
  warna_barang         String?
  header               SalesOrderHeader? @relation(fields: [header_id], references: [id], onDelete: Cascade)
  inventory_item       Item?             @relation("ItemToSalesOrder", fields: [inventory_item_id], references: [id])
  spkItems             SpkItem[]

  @@map("sales_order")
}

model Spk {
  id                  String             @id @default(uuid()) @db.Uuid
  spkNumber           String             @unique
  leadId              Int
  tglSpk              DateTime           @default(now())
  deadline            DateTime?
  catatan             String?
  status              String             @default("QUEUE")
  userId              String             @db.Uuid
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  signedUrl           String?
  inventoryApproved   Boolean            @default(false)
  inventoryApprovedAt DateTime?
  inventoryUserId     String?            @db.Uuid
  warehouseApproved   Boolean            @default(false)
  warehouseApprovedAt DateTime?
  soHeaderId          Int?               @unique
  shippingId          String?            @db.Uuid
  invoices            Invoice[]
  payments            PaymentHistory[]
  productionRequest   ProductionRequest?
  purchaseOrders      PurchaseOrder[]
  lead                Lead               @relation(fields: [leadId], references: [id])
  soHeader            SalesOrderHeader?  @relation(fields: [soHeaderId], references: [id])
  user                User               @relation(fields: [userId], references: [id])
  shipping            Shipping?          @relation(fields: [shippingId], references: [id])
  spkItems            SpkItem[]
  materialUsages      SpkMaterialUsage[]
  wasteStocks         WasteStock[]       @relation("SpkToWaste")

  @@index([status])
  @@index([spkNumber])
  @@map("spk")
}

model SpkItem {
  id                  String            @id @default(uuid()) @db.Uuid
  spkId               String            @db.Uuid
  salesOrderId        Int?
  namaBarang          String
  qty                 Float
  satuan              String
  fulfillmentMethod   String            @default("FROM_STOCK")
  productionRequestId String?           @db.Uuid
  createdAt           DateTime          @default(now())
  fulfillmentStatus   String            @default("PENDING")
  itemId              String?           @db.Uuid
  updatedAt           DateTime          @updatedAt
  invoicedQty         Float             @default(0)
  itemStatus          String            @default("QUEUE")
  producedQty         Float             @default(0)
  shippedQty          Float             @default(0)
  readyQty            Float             @default(0)
  approvedQty         Float             @default(0)
  recycledQty         Float             @default(0)
  productionStatus    String?
  overproductionChoice String?          
  invoiceItems        InvoiceItem[]
  shipping_item       shipping_item[]
  item                Item?             @relation("ItemToSpkItem", fields: [itemId], references: [id])
  salesOrder          SalesOrder?       @relation(fields: [salesOrderId], references: [id])
  spk                 Spk               @relation(fields: [spkId], references: [id], onDelete: Cascade)
  progressHistory     SpkItemProgress[]
  returns             ProductReturn[]

  @@map("spk_item")
}

model SpkItemProgress {
  id         String   @id @default(uuid()) @db.Uuid
  spkItemId  String   @db.Uuid
  stage      String
  resultQty  Float
  unit       String?
  wasteQty   Float    @default(0)
  wasteUnit  String?
  operatorId String?  @db.Uuid
  createdAt  DateTime @default(now())
  spkItem    SpkItem  @relation(fields: [spkItemId], references: [id], onDelete: Cascade)

  @@index([spkItemId])
  @@map("spk_item_progress")
}

model SpkMaterialUsage {
  id             String  @id @default(uuid()) @db.Uuid
  materialId     String  @db.Uuid
  quantityNeeded Float
  isSufficient   Boolean @default(true)
  remainingQty   Float?  @default(0)
  spkId          String  @db.Uuid
  material       Item    @relation("MaterialToSpk", fields: [materialId], references: [id])
  spk            Spk     @relation(fields: [spkId], references: [id], onDelete: Cascade)

  @@index([spkId])
  @@index([materialId])
  @@map("spk_material_usage")
}

model ItemType {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  category  String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  items     Item[]

  @@index([category])
  @@map("item_type")
}

model Unit {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  items     Item[]

  @@map("unit")
}

model Item {
  id                     String                  @id @default(uuid()) @db.Uuid
  code                   String                  @unique
  name                   String
  itemTypeId             String                  @db.Uuid
  category               String
  productGroup           String?
  unitId                 String                  @db.Uuid
  stockMinimum           Float                   @default(0)
  currentStock           Float                   @default(0)
  isActive               Boolean                 @default(true)
  vendor                 String?
  hargaSatuan            Float?
  ukuran                 String?
  kuantitas              Float?
  isTrading              Boolean                 @default(false)
  createdAt              DateTime                @default(now())
  updatedAt              DateTime                @updatedAt
  reservedStock          Float                   @default(0)
  ketebalan              String?
  spesifikasi_tambahan   String?
  warna                  String?
  itemType               ItemType                @relation(fields: [itemTypeId], references: [id])
  unit                   Unit                    @relation(fields: [unitId], references: [id])
  productionRequestItems ProductionRequestItem[]
  purchaseOrderItems     PurchaseOrderItem[]
  sales_orders           SalesOrder[]            @relation("ItemToSalesOrder")
  spkItems               SpkItem[]               @relation("ItemToSpkItem")
  spkMaterials           SpkMaterialUsage[]      @relation("MaterialToSpk")
  stockHistories         StockHistory[]
  transactions           Transaction[]
  wasteStocks            WasteStock[]            @relation("ItemToWaste")

  @@index([category])
  @@index([productGroup])
  @@index([isActive])
  @@index([isTrading])
}

model WasteStock {
  id         String   @id @default(uuid()) @db.Uuid
  materialId String   @db.Uuid
  spkId      String   @db.Uuid
  quantity   Float    @default(0)
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  material   Item     @relation("ItemToWaste", fields: [materialId], references: [id])
  spk        Spk      @relation("SpkToWaste", fields: [spkId], references: [id], onDelete: Cascade)

  @@index([materialId])
  @@index([spkId])
  @@map("waste_stock")
}

model Transaction {
  id             String         @id @default(uuid()) @db.Uuid
  date           DateTime
  type           String
  itemId         String         @db.Uuid
  quantity       Float
  price          Float?
  vendor         String?
  destination    String?
  spkNumber      String?
  memo           String
  userId         String         @db.Uuid
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  source         String?
  stockHistories StockHistory[]
  item           Item           @relation(fields: [itemId], references: [id])
  user           User           @relation(fields: [userId], references: [id])

  @@index([date])
  @@index([type])
  @@index([source])
  @@index([itemId])
  @@index([userId])
  @@map("transaction")
}

model StockHistory {
  id            String       @id @default(uuid()) @db.Uuid
  itemId        String       @db.Uuid
  transactionId String?      @db.Uuid
  userId        String       @db.Uuid
  previousStock Float
  quantity      Float
  newStock      Float
  reason        String
  createdAt     DateTime     @default(now())
  item          Item         @relation(fields: [itemId], references: [id], onDelete: Cascade)
  transaction   Transaction? @relation(fields: [transactionId], references: [id])
  user          User         @relation(fields: [userId], references: [id])

  @@index([itemId])
  @@index([transactionId])
  @@index([userId])
  @@index([createdAt])
  @@map("stock_history")
}

model ProductionRequest {
  id          String                  @id @default(uuid()) @db.Uuid
  spkNumber   String                  @unique
  productName String
  memo        String
  status      String
  userId      String                  @db.Uuid
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
  isApproved  Boolean                 @default(false)
  approvedAt  DateTime?
  spk         Spk                     @relation(fields: [spkNumber], references: [spkNumber])
  user        User                    @relation(fields: [userId], references: [id])
  items       ProductionRequestItem[]

  @@index([status])
  @@index([userId])
  @@index([createdAt])
  @@map("production_request")
}

model ProductionRequestItem {
  id                  String            @id @default(uuid()) @db.Uuid
  productionRequestId String            @db.Uuid
  itemId              String            @db.Uuid
  quantity            Float
  createdAt           DateTime          @default(now())
  item                Item              @relation(fields: [itemId], references: [id])
  productionRequest   ProductionRequest @relation(fields: [productionRequestId], references: [id], onDelete: Cascade)

  @@index([productionRequestId])
  @@index([itemId])
  @@map("production_request_item")
}

model PurchaseOrder {
  id                 String              @id @default(uuid()) @db.Uuid
  kepada             String
  nomorPO            String              @unique
  tanggal            DateTime
  jatuhTempo         DateTime
  keteranganTambahan String?
  hormatKami         String?
  userId             String              @db.Uuid
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  spkId              String?             @db.Uuid
  status             String              @default("PENDING")
  
  // Payment Info
  paymentMethod      String?             // CASH, INSTALLMENT
  paymentTerm        String?             // 7, 14, 30, CUSTOM
  totalAmount        Float               @default(0)
  paidAmount         Float               @default(0)
  paymentStatus      String              @default("UNPAID") // UNPAID, PARTIAL, PAID

  // Receipt Info
  isReceived         Boolean             @default(false)
  receivedAt         DateTime?
  suratJalanUrl      String?
  signatureUrl       String?

  spk                Spk?                @relation(fields: [spkId], references: [id])
  user               User                @relation(fields: [userId], references: [id])
  items              PurchaseOrderItem[]
  payments           PurchaseOrderPayment[]

  @@index([nomorPO])
  @@index([userId])
  @@index([tanggal])
  @@index([spkId])
  @@index([status])
  @@map("purchase_order")
}

model PurchaseOrderPayment {
  id              String        @id @default(uuid()) @db.Uuid
  purchaseOrderId String        @db.Uuid
  amount          Float
  paymentDate     DateTime      @default(now())
  method          String        @default("TRANSFER")
  notes           String?
  userId          String        @db.Uuid
  createdAt       DateTime      @default(now())
  
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  user            User          @relation(fields: [userId], references: [id])

  @@map("purchase_order_payment")
}

model PurchaseOrderItem {
  id              String        @id @default(uuid()) @db.Uuid
  purchaseOrderId String        @db.Uuid
  itemId          String?       @db.Uuid
  namaBarang      String
  ukuran          String?
  qty             Float
  satuan          String
  noticeMerkJenis String?
  subTotal        Float
  createdAt       DateTime      @default(now())
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  item            Item?         @relation(fields: [itemId], references: [id])

  @@index([purchaseOrderId])
  @@index([itemId])
  @@map("purchase_order_item")
}

model DailyProductionLog {
  id           String                    @id @default(uuid()) @db.Uuid
  date         DateTime
  shift        String
  operatorName String
  userId       String                    @db.Uuid
  createdAt    DateTime                  @default(now())
  updatedAt    DateTime                  @updatedAt
  activities   DailyProductionActivity[]
  user         User                      @relation(fields: [userId], references: [id])

  @@index([date])
  @@index([shift])
  @@map("daily_production_log")
}

model DailyProductionActivity {
  id              String             @id @default(uuid()) @db.Uuid
  productionLogId String             @db.Uuid
  processName     String
  resultQty       Float
  unit            String
  wasteQty        Float
  wasteUnit       String
  createdAt       DateTime           @default(now())
  productionLog   DailyProductionLog @relation(fields: [productionLogId], references: [id], onDelete: Cascade)

  @@map("daily_production_activity")
}

model PaymentHistory {
  id             String            @id @default(uuid()) @db.Uuid
  leadId         Int
  amount         Float
  paymentDate    DateTime          @default(now())
  method         String
  statusAtTime   String
  isFinalPayment Boolean           @default(false)
  notes          String?
  userId         String            @db.Uuid
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  invoiceId      String?           @db.Uuid
  soHeaderId     Int?
  spkId          String?           @db.Uuid
  invoice        Invoice?          @relation(fields: [invoiceId], references: [id])
  lead           Lead              @relation(fields: [leadId], references: [id], onDelete: Cascade)
  soHeader       SalesOrderHeader? @relation(fields: [soHeaderId], references: [id])
  spk            Spk?              @relation(fields: [spkId], references: [id])
  user           User              @relation(fields: [userId], references: [id])

  @@index([leadId])
  @@map("payment_history")
}

model Invoice {
  id             String           @id @default(uuid()) @db.Uuid
  nomorInvoice   String           @unique
  spkId          String           @db.Uuid
  leadId         Int
  userId         String           @db.Uuid
  subTotal       Float
  diskon         Float            @default(0)
  pajakPpn       Float            @default(0)
  pajakPph       Float            @default(0)
  biayaTambahan  Float            @default(0)
  grandTotal     Float
  status         String           @default("UNPAID")
  jatuhTempo     DateTime
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  isPartial      Boolean          @default(false)
  deductedAmount Float            @default(0)
  invoiceType    String           @default("PARTIAL")
  lead           Lead             @relation(fields: [leadId], references: [id])
  spk            Spk              @relation(fields: [spkId], references: [id], onDelete: Cascade)
  user           User             @relation(fields: [userId], references: [id])
  items          InvoiceItem[]
  payments       PaymentHistory[]

  @@map("invoice")
}

model InvoiceItem {
  id          String  @id @default(uuid()) @db.Uuid
  invoiceId   String  @db.Uuid
  namaBarang  String
  qtyAktual   Float
  satuan      String
  hargaSatuan Float
  subTotal    Float
  spkItemId   String  @db.Uuid
  invoice     Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  spkItem     SpkItem @relation(fields: [spkItemId], references: [id])

  @@map("invoice_item")
}

model Shipping {
  id             String          @id @default(uuid()) @db.Uuid
  driverId       String          @db.Uuid
  tglKirim       DateTime        @default(now())
  estimasi       DateTime?
  catatan        String?
  fotoBuktiUrl   String?
  penerimaNama   String?
  waktuSampai    DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  catatanSelesai String?
  driver         User            @relation("DriverToShipping", fields: [driverId], references: [id])
  shipping_item  shipping_item[]
  spks           Spk[]

  @@map("shipping")
}

model Notification {
  id        String   @id @default(uuid()) @db.Uuid
  title     String
  message   String
  type      String
  targetUrl String?
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

  @@map("notification")
}

model shipping_item {
  id         String   @id @db.Uuid
  shippingId String   @db.Uuid
  spkItemId  String   @db.Uuid
  qty        Float
  createdAt  DateTime @default(now())
  shipping   Shipping @relation(fields: [shippingId], references: [id], onDelete: Cascade)
  spk_item   SpkItem  @relation(fields: [spkItemId], references: [id])
  returns    ProductReturn[]

  @@index([shippingId])
  @@index([spkItemId])
}

model ProductReturn {
  id             String        @id @default(uuid()) @db.Uuid
  shippingItemId String        @db.Uuid
  spkItemId      String        @db.Uuid
  qty            Float
  reason         String        // REPACK, RECYCLE, REPAIR
  isHandled      Boolean       @default(false)
  notes          String?
  createdAt      DateTime      @default(now())
  shipping_item  shipping_item @relation(fields: [shippingItemId], references: [id], onDelete: Cascade)
  spk_item       SpkItem       @relation(fields: [spkItemId], references: [id])

  @@index([shippingItemId])
  @@index([spkItemId])
  @@map("return_item")
}
